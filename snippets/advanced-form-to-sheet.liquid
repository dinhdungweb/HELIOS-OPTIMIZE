<div class="advanced-form-wrapper" data-banner-position="{{ af-banner-position }}">
  {% if af-banner-image and af-banner-position != 'none' %}
    <div class="advanced-form-banner">
      <img src="{{ af-banner-image | image_url: width: 600 }}" alt="Form Banner" class="form-banner-img" id="zoomableImage">
    </div>
  {% endif %}

  <div class="advanced-form-content">
    <div class="form-header">
      {% if af-title != blank %}
        <h2 class="form-title">{{ af-title }}</h2>
      {% endif %}
      {% if af-subtitle != blank %}
        <p class="form-subtitle">{{ af-subtitle }}</p>
      {% endif %}
      {% if af-description != blank %}
        <div class="form-description">{{ af-description }}</div>
      {% endif %}
    </div>

    <form id="advanced-form" class="advanced-form" action="{{ af-form-action-url }}" method="post" novalidate>
      {% for block in section.blocks %}
        <div class="form-group" {{ block.shopify_attributes }}>
          {% if block.type == 'text_field' %}
            <label for="field-{{ block.id }}" class="form-label">
              {{ block.settings.label }}
              {% if block.settings.required %}<span class="required">*</span>{% endif %}
            </label>
            <input 
              type="{{ block.settings.input_type }}" 
              id="field-{{ block.id }}" 
              name="{{ block.settings.entry }}" 
              placeholder="{{ block.settings.placeholder }}"
              class="form-input"
              {% if block.settings.required %}required{% endif %}>

          {% elsif block.type == 'textarea_field' %}
            <label for="field-{{ block.id }}" class="form-label">
              {{ block.settings.label }}
              {% if block.settings.required %}<span class="required">*</span>{% endif %}
            </label>
            <textarea 
              id="field-{{ block.id }}" 
              name="{{ block.settings.entry }}" 
              placeholder="{{ block.settings.placeholder }}"
              class="form-textarea"
              {% if block.settings.required %}required{% endif %}></textarea>

          {% elsif block.type == 'select_field' %}
            <label for="field-{{ block.id }}" class="form-label">
              {{ block.settings.label }}
              {% if block.settings.required %}<span class="required">*</span>{% endif %}
            </label>
            <select 
              id="field-{{ block.id }}" 
              name="{{ block.settings.entry }}" 
              class="form-select"
              {% if block.settings.required %}required{% endif %}>
              <option value="">-- Ch·ªçn --</option>
              {% assign separator = newline %}
              {% if block.settings.options contains ',' %}
                {% assign separator = ',' %}
              {% endif %}
              {% assign options = block.settings.options | split: separator %}
              {% for option in options %}
                {% assign option = option | strip %}
                {% if option != blank %}
                  <option value="{{ option }}">{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>

          {% elsif block.type == 'checkbox_field' %}
            <fieldset class="form-fieldset">
              <legend class="form-label">
                {{ block.settings.label }}
                {% if block.settings.required %}<span class="required">*</span>{% endif %}
              </legend>
              {% assign separator = newline %}
              {% if block.settings.options contains ',' %}
                {% assign separator = ',' %}
              {% endif %}
              {% assign options = block.settings.options | split: separator %}
              {% for option in options %}
                {% assign option = option | strip %}
                {% if option != blank %}
                  <div class="checkbox-group">
                    <input 
                      type="checkbox" 
                      id="checkbox-{{ block.id }}-{{ forloop.index }}" 
                      name="{{ block.settings.entry }}" 
                      value="{{ option }}"
                      class="form-checkbox">
                    <label for="checkbox-{{ block.id }}-{{ forloop.index }}" class="checkbox-label">
                      {{ option }}
                    </label>
                  </div>
                {% endif %}
              {% endfor %}
            </fieldset>

          {% elsif block.type == 'radio_field' %}
            <fieldset class="form-fieldset">
              <legend class="form-label">
                {{ block.settings.label }}
                {% if block.settings.required %}<span class="required">*</span>{% endif %}
              </legend>
              {% assign separator = newline %}
              {% if block.settings.options contains ',' %}
                {% assign separator = ',' %}
              {% endif %}
              {% assign options = block.settings.options | split: separator %}
              {% for option in options %}
                {% assign option = option | strip %}
                {% if option != blank %}
                  <div class="radio-group">
                    <input 
                      type="radio" 
                      id="radio-{{ block.id }}-{{ forloop.index }}" 
                      name="{{ block.settings.entry }}" 
                      value="{{ option }}"
                      class="form-radio"
                      {% if block.settings.required %}required{% endif %}>
                    <label for="radio-{{ block.id }}-{{ forloop.index }}" class="radio-label">
                      {{ option }}
                    </label>
                  </div>
                {% endif %}
              {% endfor %}
            </fieldset>
          {% endif %}
        </div>
      {% endfor %}

      <div class="form-actions">
        <button type="submit" class="form-submit-btn" style="background-color: {{ af-button-color }};">
          {{ af-button-text }}
        </button>
      </div>

      <div id="form-message" class="form-message" style="display: none;"></div>
    </form>
  </div>
</div>

<!-- Image Zoom Modal -->
<div class="image-zoom-overlay" id="imageZoomOverlay">
  <button class="close-btn" id="closeZoom">&times;</button>
  <img src="" alt="Zoomed Image" id="zoomedImage">
</div>

<style>
  .advanced-form-wrapper {
    display: flex;
    gap: 40px;
    max-width: 1200px;
    margin: 60px auto;
    padding: 0 20px;
  }

  .advanced-form-wrapper[data-banner-position="none"] {
    justify-content: center;
  }

  .advanced-form-wrapper[data-banner-position="right"] {
    flex-direction: row-reverse;
  }

  .advanced-form-banner {
    flex: 0 0 45%;
    overflow: hidden;
    border-radius: 8px;
  }

  .form-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .form-banner-img:hover {
    transform: scale(1.02);
  }

  .advanced-form-content {
    flex: 1;
    min-width: 300px;
  }

  .form-header {
    margin-bottom: 30px;
  }

  .form-title {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 10px 0;
    color: #FAB320;
  }

  .form-subtitle {
    font-size: 16px;
    color: #666;
    margin: 0 0 15px 0;
  }

  .form-description {
    font-size: 14px;
    color: #999;
    line-height: 1.6;
  }

  .advanced-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #f2f2f2;
  }

  .required {
    color: #e74c3c;
    margin-left: 4px;
  }

  .form-input,
  .form-select,
  .form-textarea {
    background-color: #f8f8f8;
    color: #333;
    border: 1px solid #ddd;
    padding: 10px 12px;
    border-radius: 4px;
    font-size: 13px;
    font-family: inherit;
    transition: all 0.3s ease;
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    background-color: #fff;
    border-color: #FAB320;
    outline: none;
    box-shadow: 0 0 0 3px rgba(250, 179, 32, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 120px;
  }

  .form-fieldset {
    border: none;
    padding: 0;
    margin: 0;
  }

  .checkbox-group,
  .radio-group {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  .form-checkbox,
  .form-radio {
    margin-right: 8px;
    cursor: pointer;
    width: 16px;
    height: 16px;
  }

  .checkbox-label,
  .radio-label {
    font-size: 13px;
    color: #f2f2f2;
    cursor: pointer;
  }

  .form-actions {
    display: flex;
    justify-content: flex-start;
  }

  .form-submit-btn {
    padding: 10px 30px;
    background-color: #FAB320;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .form-submit-btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(250, 179, 32, 0.3);
  }

  .form-submit-btn:active {
    transform: translateY(0);
  }

  .form-message {
    padding: 12px 15px;
    border-radius: 4px;
    text-align: center;
    font-size: 13px;
    margin-top: 20px;
  }

  .form-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .form-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* Image Zoom Modal */
  .image-zoom-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
  }

  .image-zoom-overlay img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .image-zoom-overlay .close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #fff;
    color: #333;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .image-zoom-overlay .close-btn:hover {
    background: #ff5e57;
    color: #fff;
    transform: rotate(90deg);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .advanced-form-wrapper {
      flex-direction: column !important;
      gap: 20px;
      margin: 40px auto;
    }

    .advanced-form-banner {
      flex: 1;
      width: 100%;
    }

    .advanced-form-content {
      width: 100%;
    }

    .form-title {
      font-size: 24px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Form submission handler
    const form = document.getElementById("advanced-form");
    const messageDiv = document.getElementById("form-message");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(form);

      fetch(form.action, {
        method: "POST",
        body: formData,
        mode: "no-cors",
      })
        .then(() => {
          messageDiv.classList.remove("error");
          messageDiv.classList.add("success");
          messageDiv.textContent = "{{ af-success-message }}";
          messageDiv.style.display = "block";

          form.reset();

          // Auto hide message after 5 seconds
          setTimeout(() => {
            messageDiv.style.display = "none";
          }, 5000);
        })
        .catch((error) => {
          console.error("Error:", error);
          messageDiv.classList.remove("success");
          messageDiv.classList.add("error");
          messageDiv.textContent = "{{ af-error-message }}";
          messageDiv.style.display = "block";
        });
    });

    // Image zoom functionality
    const zoomableImage = document.getElementById("zoomableImage");
    const imageZoomOverlay = document.getElementById("imageZoomOverlay");
    const zoomedImage = document.getElementById("zoomedImage");
    const closeZoom = document.getElementById("closeZoom");

    if (zoomableImage) {
      zoomableImage.addEventListener("click", function () {
        const imgSrc = zoomableImage.getAttribute("src");
        zoomedImage.setAttribute("src", imgSrc);
        imageZoomOverlay.style.display = "flex";
      });

      closeZoom.addEventListener("click", function () {
        imageZoomOverlay.style.display = "none";
      });

      imageZoomOverlay.addEventListener("click", function (event) {
        if (event.target === imageZoomOverlay) {
          imageZoomOverlay.style.display = "none";
        }
      });
    }
  });
</script>
